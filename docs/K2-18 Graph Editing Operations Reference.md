# K2-18: Операции редактирования графов в production

## 1. Проблема

### Контекст
Семантический граф `K2-18` используется в EdTech продукте как основа учебного процесса:
- Кластеры графа = темы учебного плана
- Метрики узлов определяют порядок изучения, сложность, рекомендации, генерацию контента, диагностик
- К графу привязаны: прогресс студентов, результаты тестов, образовательные траектории
- Типичный масштаб графа: несколько сотен узлов, многие сотни рёбер

### Суть проблемы
После обработки контента и запуска курса преподаватель обнаруживает:
- Тема определена неверно (неправильная группировка контента)
- Тема упущена (контент не покрыт)
- Тема содержит ошибки (некорректные связи или понятия)
- Нужно добавить новый материал к работающему курсу

Граф уже в production: метрики посчитаны, студенты учатся, трекается учебный прогресс.

### Ограничения
- Прямое редактирование графа (вершины, рёбра) человеком нереалистично — масштаб неуправляем
- Пересчёт метрик дорог и ломает UX студентов (их прогресс привязан к текущим значениям) — только через "скидывание" курса
- Любые изменения должны быть безопасны для активных студентов

---

## 2. Задача

Определить набор операций редактирования, которые:
- Реализуемы технически в рамках архитектуры `K2-18`
- Безопасны для студентов в production (не скидывают состояние)
- Минимизируют пересчёт метрик
- Покрывают основные сценарии преподавателя

### Единица редактирования

**Кластер (тема)** — не отдельные вершины или рёбра.

Причины:
- Кластер = семантически связанный блок, понятный преподавателю
- Операции над кластерами имеют предсказуемые последствия
- Соответствует ментальной модели "тема курса"

---

## 3. Операции и решения

### 3.1. Редактирование метаданных темы

**Что можно:**
- Поправить название темы, ее описание (не меня сути)
- Изменить порядок отображения, сортивроки
- Добавить флаг `is_hidden: true` — скрыть тему без удаления (soft-delete)

**Влияние:** Нулевое. Косметика на уровне UI.

**Пересчёт метрик:** Нет.

**Реализация:** Прямое редактирование метаданных секции кластера (темы).

---

### 3.2. Ручные связи между темами

**Что можно:**
- Добавить связь "Тема A → Тема B" с типом (PREREQUISITE, ELABORATES) и комментарием
- Связи существуют на мета-уровне курса, не затрагивают граф узлов
- Работает как внутри одного графа, так и между графами (см. 3.4)

**Влияние:** Только на навигацию и рекомендации. Граф не изменяется.

**Пересчёт метрик:** Нет.

**Реализация:** Все ручные связи хранятся в мета-слое курса (см. секцию 3.4 "Мета-слой курса").

**Нюансы:**
- Ручные связи могут противоречить автоматическим — нужна логика приоритетов или флаг `manual_override`
- Продукт должен уметь читать оба типа связей

---

### 3.3. Удаление темы (Soft Delete)

**Механизм:**
- НЕ физическое удаление, а флаги: `is_deleted: true`, `deleted_at`, `deleted_by`
- Вершины Chunk и Assessment помечаются удалёнными
- Вершины Concept НЕ удаляются — могут участвовать в других кластерах
- Рёбра от/к удалённым вершинам игнорируются LMS

**Влияние:**
- LMS не показывает тему новым студентам
- Студенты "в процессе" видят тему как deprecated или получают миграцию
- Данные сохраняются для аудита и возможного восстановления

**Пересчёт метрик:** Нет.

**Нюансы:**
- `cluster_id` концептов остаётся прежним (исторический факт)
- Inter-cluster links с удалённым кластером помечаются `deprecated`
- Нужен отчёт перед удалением: сколько студентов затронуто

---

### 3.4. Мета-слой курса

Мета-слой существует **всегда**, даже для курса с одним графом. Это центральное место для:
- Реестра графов курса
- Автоматических связей через общие концепты (concept bridges)
- Ручных связей преподавателя (manual links)

**Структура:**
```json
{
  "course_id": "algorithms_101",
  "version": "1.2.0",
  
  "graphs": [
    {
      "id": "main",
      "file": "LearningChunkGraph_wow.json",
      "dict": "ConceptDictionary_wow.json",
      "is_primary": true,
      "added_at": "2024-09-01"
    },
    {
      "id": "addon_dp",
      "file": "LearningChunkGraph_addon_dp.json",
      "dict": "ConceptDictionary_addon_dp.json",
      "is_primary": false,
      "parent_dict": "ConceptDictionary_wow.json",
      "added_at": "2025-01-21"
    }
  ],
  
  "concept_bridges": [
    {
      "concept_id": "handbook:algoritm",
      "in_graphs": ["main", "addon_dp"],
      "clusters": {"main": 3, "addon_dp": [0, 1]}
    }
  ],
  
  "manual_links": [
    {
      "from": {"graph": "main", "cluster": 5},
      "to": {"graph": "main", "cluster": 10},
      "type": "PREREQUISITE",
      "reason": "Комментарий преподавателя",
      "created_by": "teacher@edu",
      "created_at": "2025-01-21T12:00:00Z"
    },
    {
      "from": {"graph": "main", "cluster": 3},
      "to": {"graph": "addon_dp", "cluster": 0},
      "type": "ELABORATES",
      "reason": "Дополнительный материал к теме Алгоритмы",
      "created_by": "teacher@edu",
      "created_at": "2025-01-21T14:00:00Z"
    }
  ]
}
```

**Поля:**

- `graphs[]` — реестр всех графов курса
  - `id` — уникальный идентификатор графа
  - `file`, `dict` — файлы графа и словаря
  - `is_primary` — основной граф (один на курс)
  - `parent_dict` — словарь-база для addon графов

- `concept_bridges[]` — автоматически вычисляемые связи через общие концепты
  - `concept_id` — ID концепта из словаря
  - `in_graphs` — в каких графах присутствует
  - `clusters` — в каких кластерах каждого графа

- `manual_links[]` — ручные связи преподавателя
  - `from`, `to` — источник и цель (граф + кластер)
  - `type` — тип связи (PREREQUISITE, ELABORATES)
  - `reason` — комментарий преподавателя
  - `created_by`, `created_at` — аудит

---

### 3.5. Добавление новой темы (новый контент)

**Механизм:**

Новый контент обрабатывается как отдельный граф:
1. Текст → K2-18 pipeline с **существующим словарём** как базой
2. Результат: отдельный `LearningChunkGraph_addon_X.json`
3. Louvain кластеризация только для нового графа
4. Регистрация в мета-слое (`graphs[]`)
5. Автоматический расчёт `concept_bridges` через общие концепты
6. При необходимости — ручные связи в `manual_links`

**Влияние:**
- Основной граф не изменяется вообще
- Новый граф имеет свои метрики (валидны в своём контексте)
- Продукт навигирует между графами через общие концепты и ручные связи

**Пересчёт метрик:** Только для нового графа (изолированно).

**Нюансы:**
- Если 0 общих концептов — граф полностью изолирован, нужна ручная связь
- Если 100% концептов общие — предупредить о сильном пересечении (возможно, контент избыточен)
- Можно удалить addon без последствий для основного графа

---

### 3.6. Замена темы

**Механизм:** Комбинация операций:
1. Soft delete старого кластера (3.3)
2. Добавление нового контента (3.5)
3. Сортировка и перенос ручных связей со старого на новый
4. Миграция студентов (на усмотрение продукта)

**Пересчёт метрик:** Только для нового контента.

---

### 3.7. Мердж концептов в словаре

**Сценарий:** Два концепта оказались дубликатами ("ООП" и "объектно-ориентированное программирование").

**Механизм:**
1. Выбрать "главный" концепт
2. Aliases добавить к главному
3. Рёбра от/к aliases перенаправить на главного
4. Дедупликация рёбер (по `source-target-type`)
5. Soft delete узлов-aliases

**Влияние:** Топология графа изменяется.

**Пересчёт метрик:** Да, неизбежно. Ставим флаг `metrics_stale: true`.

**Нюансы:**
- Если концепты из разных кластеров — `cluster_id` берём от главного
- Редкая операция, допустим full recompute
- Нужен preview: "Будет изменено X рёбер, затронуто Y чанков"

---

## 4. Что точно не выйдет

### 4.1. Ручное редактирование вершин и рёбер графа
**Почему:** Масштаб (многие сотни объектов), сложность семантики (9 типов рёбер), риск нарушить инварианты графа.

### 4.2. Перемещение вершин между кластерами
**Почему:** Ломает семантику Louvain-кластеризации. Кластер — это группа связанных узлов, ручное перемещение делает метрики бессмысленными.

### 4.3. Добавление концепта вручную
**Почему:** Концепт без привязки к контенту бессмысленен. Откуда definition? Откуда связи MENTIONS? Это противоречит идее автоматической экстракции.

### 4.4. Изменение метрик вручную
**Почему:** Метрики вычислены из топологии. Ручное изменение создаёт несогласованность: граф говорит одно, метрики — другое.

### 4.5. Инкрементальный пересчёт глобальных метрик
**Почему:** PageRank, educational_importance нормированы (сумма = 1). Любое изменение топологии требует полного пересчёта для сохранения инварианта. Частичный пересчёт даст некорректные значения.

---

## 5. Общие принципы

### 5.1. Soft Delete везде
Вместо физического удаления — флаги `is_deleted`, `deleted_at`, `deleted_by`. Причины:
- Возможность восстановления
- Обратная совместимость
- Аудит изменений

### 5.2. Версионирование
Каждое значимое изменение = новая версия в мета-слое:
```json
{
  "course_id": "algorithms_101",
  "version": "2.3.1",
  "parent_version": "2.3.0", 
  "changes": ["Soft delete cluster 7 in main", "Added manual link main:5 → main:10"]
}
```
Студент привязан к версии, на которой начал обучение.

### 5.3. Preview перед изменением
Перед любой операцией показать преподавателю:
- Сколько студентов затронуто
- Какие прогрессы станут невалидными
- Какие связи изменятся

### 5.4. Модульность графов
Новый контент = отдельный граф со своими метриками. Связь через мета-слой и общие концепты. Основной граф остаётся неизменным.

### 5.5. Мета-слой как единая точка управления
Все связи между темами (автоматические и ручные), реестр графов, версионирование — в мета-слое курса. Графы остаются иммутабельными после создания.

---

## 6. Матрица операций

| Операция | Реализуемость | Пересчёт метрик | Риск для студентов |
|----------|---------------|-----------------|-------------------|
| Редактирование метаданных | ✅ Легко | Нет | Нулевой |
| Скрытие темы | ✅ Легко | Нет | Низкий |
| Ручные связи между темами | ✅ Легко | Нет | Нулевой |
| Soft delete темы | ✅ Средне | Нет | Средний* |
| Добавление темы (модуль) | ✅ Средне | Локально | Нулевой |
| Замена темы | ⚠️ Сложно | Локально | Средний* |
| Мердж концептов | ⚠️ Средне | Да (full) | Низкий |

* Требует миграции студентов, которые были "в процессе"

---

## 7. Связанные документы

- [K2-18 Architecture](K2-18%20Architecture.md) — общая архитектура системы
- [K2-18 Graph Metrics Computation Algorithms Reference](K2-18%20Graph%20Metrics%20Computation%20Algorithms%20Reference.md) — детали вычисления метрик
- [viz_graph_split.md](specs/viz_graph_split.md) — спецификация утилиты разбиения по кластерам
- [ConceptDictionary.schema.json](../src/schemas/ConceptDictionary.schema.json) — схема словаря концептов
- [LearningChunkGraph.schema.json](../src/schemas/LearningChunkGraph.schema.json) — схема графа
