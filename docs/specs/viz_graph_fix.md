# viz_graph_fix.md

## Status: READY

Module for marking LLM-generated content and updating concept terms in enriched knowledge graph.

## Module Purpose

The `graph_fix.py` utility marks LLM-generated content in the enriched knowledge graph for quality assessment by methodologists. It adds `[added_by=LLM]` markers to fields generated by LLM and updates Concept nodes' text field with proper term formatting from ConceptDictionary.

## CLI Interface

### Usage

```bash
# Normal run - modifies files
python -m viz.graph_fix

# Dry run - shows changes without modifying files
python -m viz.graph_fix --dry-run
```

### Command-line Arguments

- `--dry-run` - Analyze and show changes without modifying files

### Input Files

- `/viz/data/out/ConceptDictionary_wow.json` - Concept dictionary with terms and aliases
- `/viz/data/out/LearningChunkGraph_wow.json` - Enriched graph to process

### Output Files

- `/viz/data/out/LearningChunkGraph_wow.json` - Modified graph with markers (overwrites input)

### Log Files

- `/viz/logs/graph_fix.log` - Execution log with timestamps and statistics

## Terminal Output

### Normal Mode

```
✓ Graph fix completed successfully
  - Chunks definitions marked: 84
  - Assessments definitions marked: 0
  - Concepts text updated: 115
  - Edge conditions marked: 311
  - Total changes: 510
  - Output saved to: /viz/data/out/LearningChunkGraph_wow.json
```

### Dry-Run Mode

```
[DRY-RUN MODE] Analyzing changes without modifying files...

================================================================================
DRY-RUN MODE - No files were modified
================================================================================

Definition changes (showing first 5):
  [Chunk] chunk_1: "Original definition..." → "[added_by=LLM] Original definition..."
  [Assessment] assessment_1: "Test question..." → "[added_by=LLM] Test question..."
  ...

Concept text updates (showing first 5):
  [Concept] concept_1: "Old text..." → "Primary Term (alias1, alias2)..."
  ...

Edge condition changes (showing first 5):
  [Edge] node1→node2 (TYPE): "Condition..." → "[added_by=LLM] Condition..."
  ...

Summary of changes that would be made:
  - Chunk definitions marked: 84
  - Assessment definitions marked: 5
  - Concept texts updated: 115
  - Edge conditions marked: 311
  - Total changes: 515
================================================================================
```

## Core Algorithm

### 1. Process Chunk and Assessment Definitions

For nodes where `type` is "Chunk" or "Assessment":
- Check if `definition` field exists and is not empty
- Skip if already starts with `[added_by=LLM]`
- Prepend `[added_by=LLM] ` to the definition
- Track count of modified definitions

### 2. Process Concept Nodes

For nodes where `type` is "Concept":
- Find corresponding concept in ConceptDictionary by matching node.id with concept_id
- If concept not found, log warning and skip
- Build new text from term:
  - If no aliases: use just `term.primary`
  - If aliases exist: format as `term.primary (alias1, alias2, alias3)`
- Replace node's `text` field (always overwrite, safe to repeat)
- Track count of updated concepts

### 3. Process Edge Conditions

For edges where `conditions` field exists and is not empty:
- Skip if contains any of: `added_by=`, `fixed_by=`, `auto_generated` (anywhere in string)
- Skip if already starts with `[added_by=LLM]`
- Prepend `[added_by=LLM] ` to conditions
- Track count of modified conditions

### 4. Update Metadata

Preserve existing `_meta` section and add/update:
```json
"graph_fix_applied": {
  "timestamp": "2024-12-XX HH:MM:SS",
  "chunks_definitions_marked": 84,
  "assessments_definitions_marked": 5,
  "concepts_text_updated": 115,
  "edges_conditions_marked": 311
}
```

### 5. Validate and Save

- Validate modified graph against LearningChunkGraph schema
- Save to `/viz/data/out/LearningChunkGraph_wow.json` (overwrite)

## Public API

### setup_logging(log_file: Path) -> logging.Logger
Set up logging configuration with file and console handlers.
- **Input**: log_file - Path to log file
- **Returns**: Configured logger instance
- **Side effects**: Creates logs directory if not exists

### load_input_files(data_dir: Path, logger: Logger) -> Tuple[Dict, Dict]
Load and validate ConceptDictionary and LearningChunkGraph files.
- **Input**: data_dir - Directory containing input files, logger
- **Returns**: Tuple of (concepts_data, graph_data)
- **Raises**: SystemExit(EXIT_INPUT_ERROR) if files not found or invalid

### process_chunk_assessment_definitions(nodes: List[Dict], dry_run: bool, logger: Logger) -> Tuple[int, int, List[str]]
Process definitions in Chunk and Assessment nodes.
- **Input**: nodes - List of graph nodes, dry_run flag, logger
- **Returns**: Tuple of (chunks_marked, assessments_marked, examples)
- **Note**: Modifies nodes in-place unless dry_run=True

### process_concept_text(nodes: List[Dict], concepts_data: Dict, dry_run: bool, logger: Logger) -> Tuple[int, List[str]]
Update text field in Concept nodes from ConceptDictionary.
- **Input**: nodes, concepts dictionary, dry_run flag, logger
- **Returns**: Tuple of (concepts_updated, examples)
- **Note**: Logs warning for missing concepts

### process_edge_conditions(edges: List[Dict], dry_run: bool, logger: Logger) -> Tuple[int, List[str]]
Process conditions field in edges.
- **Input**: edges - List of graph edges, dry_run flag, logger
- **Returns**: Tuple of (edges_marked, examples)
- **Note**: Skips edges with existing markers

### update_metadata(graph_data: Dict, stats: Dict, logger: Logger) -> None
Update graph metadata with fix statistics.
- **Input**: graph_data, statistics dictionary, logger
- **Side effects**: Adds graph_fix_applied to _meta

### save_graph(graph_data: Dict, output_file: Path, logger: Logger) -> None
Save modified graph to file after validation.
- **Input**: graph_data, output file path, logger
- **Raises**: SystemExit(EXIT_RUNTIME_ERROR) if validation fails
- **Raises**: SystemExit(EXIT_IO_ERROR) if save fails

### print_dry_run_summary(examples: Dict, stats: Dict) -> None
Print dry-run summary to console.
- **Input**: examples dictionary, statistics dictionary
- **Side effects**: Prints formatted summary to stdout

### main() -> int
Main entry point for the utility.
- **Returns**: Exit code (EXIT_SUCCESS or error code)

## Error Handling & Exit Codes

### Exit Codes
- `0` (EXIT_SUCCESS) - Successful completion
- `1` (EXIT_CONFIG_ERROR) - Configuration file not found or invalid
- `2` (EXIT_INPUT_ERROR) - Input files not found or invalid JSON/schema
- `3` (EXIT_RUNTIME_ERROR) - Modified graph fails validation
- `5` (EXIT_IO_ERROR) - File read/write errors

### Boundary Cases
- **Empty definition/conditions** - Skipped, not marked
- **Already marked content** - Skipped to ensure idempotency
- **Missing concept in dictionary** - Warning logged, node skipped
- **Malformed nodes/edges** - Skipped gracefully
- **None values** - Treated as empty, skipped

## Test Coverage

Module has comprehensive test coverage in `/tests/viz/test_graph_fix.py`:

### Test Cases (14 tests)
- `test_process_chunk_assessment_definitions` - Marking definitions
- `test_process_chunk_assessment_definitions_dry_run` - Dry-run mode
- `test_process_chunk_assessment_definitions_idempotency` - No double marking
- `test_process_concept_text` - Updating concept text with aliases
- `test_process_concept_text_no_aliases` - Concepts without aliases
- `test_process_concept_text_missing_concept` - Missing concept handling
- `test_process_edge_conditions` - Marking edge conditions
- `test_process_edge_conditions_skip_markers` - Skip existing markers
- `test_process_edge_conditions_empty` - Empty conditions handling
- `test_update_metadata` - Metadata update
- `test_load_input_files_missing` - Missing files handling
- `test_load_input_files_invalid_json` - Invalid JSON handling
- `test_full_integration` - Full processing flow
- `test_malformed_data_handling` - Malformed data structures

### Coverage
- Line coverage: 50% (core functions fully tested)
- All critical paths covered
- Edge cases and error handling tested

## Dependencies

### External Libraries
- Standard library only (json, logging, argparse, pathlib)

### Internal Modules
- `src.utils.config` - Configuration loading
- `src.utils.console_encoding` - UTF-8 output support
- `src.utils.exit_codes` - Standardized exit codes
- `src.utils.validation` - JSON schema validation

## Usage Examples

### Basic Usage
```bash
# Activate virtual environment
source .venv/bin/activate

# Run fix on production data
python -m viz.graph_fix

# Check output
ls -la viz/data/out/LearningChunkGraph_wow.json
```

### Dry-Run Mode
```bash
# Preview changes without modifying files
python -m viz.graph_fix --dry-run

# Review output and statistics
```

### Idempotency Check
```bash
# Run twice - second run should change nothing
python -m viz.graph_fix
python -m viz.graph_fix  # Should report 0 changes
```

### Check Logs
```bash
# View execution log
tail -30 viz/logs/graph_fix.log

# Check for warnings (missing concepts)
grep WARNING viz/logs/graph_fix.log
```

### Verify Metadata
```bash
# Check metadata was added
python -c "import json; g=json.load(open('viz/data/out/LearningChunkGraph_wow.json')); \
print(g['_meta']['graph_fix_applied'])"
```

## Notes

- **Idempotent** - Running multiple times is safe, no duplicate markers
- **Non-destructive** - Only adds markers, doesn't remove content
- **Validation** - Always validates against schema before saving
- **Concept warnings** - Missing concepts logged but don't stop processing
- **Skip patterns** - Any occurrence of `added_by=`, `fixed_by=`, or `auto_generated` skips marking
- **UTF-8** - All file I/O uses UTF-8 encoding
- **Atomic** - Either all changes saved or none (validation ensures consistency)